# Common Configuration (All Environments)

spring.application.name=tateca-backend

# Import Observability Configuration
spring.config.import=optional:classpath:application-observability.properties

# Database Configuration
# Added connectTimeout to prevent authentication hangs (observed in production)
# connectTimeout: TCP connection + MySQL authentication timeout
# socketTimeout: Query execution timeout for already-established connections
spring.datasource.url=jdbc:mysql://${MYSQLHOST}:${MYSQLPORT}/${MYSQLDATABASE}?serverTimezone=UTC&rewriteBatchedStatements=true&cachePrepStmts=true&useServerPrepStmts=true&connectTimeout=10000&socketTimeout=30000
spring.datasource.username=${MYSQLUSER}
spring.datasource.password=${MYSQLPASSWORD}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# HikariCP Connection Pool (Common for all environments)
# Optimized for Virtual Threads and prevents connection exhaustion
spring.datasource.hikari.minimum-idle=3
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.leak-detection-threshold=60000
spring.datasource.hikari.connection-test-query=SELECT 1

# Firebase Configuration
firebase.serviceAccountKey=${FIREBASE_SERVICE_ACCOUNT_KEY}
firebase.project.id=${FIREBASE_PROJECT_ID}

# External API Configuration
exchange.rate.api-key=${EXCHANGE_RATE_API_KEY}
exchange.rate.base-url=https://v6.exchangerate-api.com/v6

# Lambda/EventBridge API Key Configuration
lambda.api.key=${LAMBDA_API_KEY}

# Server Configuration
server.port=${PORT:8080}

# JPA Configuration
spring.jpa.hibernate.ddl-auto=none
spring.jpa.open-in-view=false

# JPA Query Timeout (30 seconds = 30000 milliseconds)
# Prevents long-running queries from holding connections indefinitely
spring.jpa.properties.jakarta.persistence.query.timeout=30000

# Transaction Timeout (30 seconds)
# Ensures transactions are committed/rolled back within reasonable time
spring.transaction.default-timeout=30

# Hibernate Batch Optimization (Common for all environments)
# Reduces N+1 queries during bulk inserts/updates
spring.jpa.properties.hibernate.jdbc.batch_size=50
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.batch_versioned_data=true

# JMX Configuration
spring.jmx.enabled=false

# Flyway Configuration
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.validate-on-migrate=true
spring.flyway.clean-disabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=0

# Virtual Threads Configuration (Java 21+)
spring.threads.virtual.enabled=true

# Resilience4j Retry Configuration
resilience4j.retry.instances.exchangeRateApi.max-attempts=3
resilience4j.retry.instances.exchangeRateApi.wait-duration=1s
resilience4j.retry.instances.exchangeRateApi.enable-exponential-backoff=true
resilience4j.retry.instances.exchangeRateApi.exponential-backoff-multiplier=2
resilience4j.retry.instances.exchangeRateApi.retry-exceptions=org.springframework.web.client.RestClientException

# SpringDoc OpenAPI Configuration (Code-First approach)
# Environment-specific overrides:
# - Development: Enabled for local API exploration
# - Production: Disabled (use GitHub Pages for documentation)
# - CI/CD: Enabled for automatic spec generation
springdoc.api-docs.path=/v3/api-docs
springdoc.api-docs.enabled=true
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.enabled=${SWAGGER_UI_ENABLED:false}
springdoc.show-actuator=true
springdoc.default-produces-media-type=application/json
springdoc.default-consumes-media-type=application/json
