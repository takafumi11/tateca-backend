<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- Spring Boot defaults -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- Console Appender for Development (Human-Readable) -->
    <appender name="CONSOLE_DEV" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%thread] %cyan(%logger{36}) - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- Console Appender for Production (JSON Structured) -->
    <appender name="CONSOLE_PROD" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <!-- Add standard fields -->
            <includeMdcKeyName>requestId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>traceId</includeMdcKeyName>
            <includeMdcKeyName>spanId</includeMdcKeyName>
            <includeMdcKeyName>status</includeMdcKeyName>
            <includeMdcKeyName>processingTimeMs</includeMdcKeyName>

            <!-- Add custom fields -->
            <customFields>{"application":"tateca-backend","environment":"production"}</customFields>

            <!-- Pretty print for local testing (can be disabled for production) -->
            <jsonGeneratorDecorator class="net.logstash.logback.decorate.PrettyPrintingJsonGeneratorDecorator"/>
        </encoder>
    </appender>

    <!-- Async Console Appender for Production (Non-blocking) -->
    <appender name="ASYNC_CONSOLE" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <appender-ref ref="CONSOLE_PROD"/>
    </appender>

    <!-- Better Stack Appender (Production Only - Direct HTTP Integration) -->
    <appender name="BETTERSTACK" class="com.tateca.tatecabackend.logging.BetterStackAppender">
        <sourceToken>${BETTER_STACK_SOURCE_TOKEN}</sourceToken>
        <endpoint>${BETTER_STACK_ENDPOINT:-https://in.logs.betterstack.com}</endpoint>
        <queueSize>1000</queueSize>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>requestId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>traceId</includeMdcKeyName>
            <includeMdcKeyName>spanId</includeMdcKeyName>
            <includeMdcKeyName>status</includeMdcKeyName>
            <includeMdcKeyName>processingTimeMs</includeMdcKeyName>
            <customFields>{"application":"tateca-backend","environment":"production"}</customFields>
        </encoder>
    </appender>

    <!-- Async Better Stack Appender (Non-blocking) -->
    <appender name="ASYNC_BETTERSTACK" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <appender-ref ref="BETTERSTACK"/>
    </appender>

    <!-- Logger Configuration -->
    <logger name="com.tateca.tatecabackend" level="INFO"/>
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.springframework.security" level="INFO"/>
    <logger name="org.hibernate.SQL" level="DEBUG"/>
    <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE"/>

    <!-- Default Profile: Use development settings when no profile is specified -->
    <root level="INFO">
        <appender-ref ref="CONSOLE_DEV"/>
    </root>

    <!-- Development Profile: Human-readable console logs -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE_DEV"/>
        </root>
        <logger name="com.tateca.tatecabackend" level="DEBUG"/>
    </springProfile>

    <!-- Production Profile: JSON structured logs with Better Stack integration -->
    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="ASYNC_CONSOLE"/>
            <appender-ref ref="ASYNC_BETTERSTACK"/>
        </root>
        <!-- Reduce noise in production -->
        <logger name="org.springframework.web" level="WARN"/>
        <logger name="org.hibernate.SQL" level="WARN"/>
    </springProfile>

    <!-- Test Profile: Minimal logging -->
    <springProfile name="test">
        <root level="WARN">
            <appender-ref ref="CONSOLE_DEV"/>
        </root>
    </springProfile>
</configuration>
